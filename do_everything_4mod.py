import pandas as pd
import numpy as np

import actual_modelling
import prep
import misc
import calculus

import wraps

import util
import metrics

df = pd.read_csv("data.csv")

df = df.rename(columns = {'Alessin_Adamant_Angel_Deck_A_Count':"Angels",
       'Bold_Battalion_Deck_A_Count':"Battalions",
       'Dreadwing_Darkfire_Dragon_Deck_A_Count':"Dragons",
       'Evil_Emperor_Eschatonus_Empyreal_Envoy_of_Entropic_End_Deck_A_Count':"Emperors",
       'Gentle_Guard_Deck_A_Count':"Guards",
       'Horrible_Hooligan_Deck_A_Count':"Hooligans",
       'Kindly_Knight_Deck_A_Count':"Knights",
       'Lilac_Lotus_Deck_A_Count':"Lotuses",
       'Murderous_Minotaur_Deck_A_Count':"Minotaurs",
       'Patchy_Pirate_Deck_A_Count':"Pirates",
       'Sword_of_Shadows_Deck_A_Count':"Swords",
       'Virtuous_Vigilante_Deck_A_Count':"Vigilantes"})

trainDf = df[:250000].reset_index(drop=True)
valDf = df[250000:300000].reset_index(drop=True)
testDf = df[300000:].reset_index(drop=True)

print(trainDf)
print(valDf)
print(testDf)

cats=[]
conts=["Angels",
       "Battalions",
       "Dragons",
       "Emperors",
       "Guards",
       "Hooligans",
       "Knights",
       "Lotuses",
       "Minotaurs",
       "Pirates",
       "Swords",
       "Vigilantes"]

models = wraps.prep_cratio_models(df, 'Deck_A_Win?', cats, conts, 4, contTargetPts=10, edge=0.002)

#models = wraps.train_cratio_models(df, 'Deck_A_Win?', 50, [0.3, 0,0,0], models, prints="verbose")
#print(models)
#models = wraps.train_cratio_models(trainDf, 'Deck_A_Win?', 100, [0, 0.3,0,0], models, prints="verbose")
#print(models)
#models = wraps.train_cratio_models(trainDf, 'Deck_A_Win?', 150, [0, 0,0.3,0], models, prints="verbose")
#print(models)
#models = wraps.train_cratio_models(trainDf, 'Deck_A_Win?', 200, [0, 0,0,0.3], models, prints="verbose")
#print(models)
#models = wraps.train_cratio_models(trainDf, 'Deck_A_Win?', 1000, [0.3, 0.3,0.3,0.3], models, prints="verbose")
#print(models)

models = [{'BASE_VALUE': 0.40110902486532024, 'featcomb': 'mult', 'conts': {'Angels': [[0, 0.8707758200825253], [1, 1.0643925006460373], [2, 1.1330544339104796], [3, 1.2150547416465596], [7, 1.2759233771104712]], 'Battalions': [[0, 1.0573174519783182], [1, 0.9940608461296465], [2, 0.9370960357875961], [3, 0.9197467079115327], [7, 0.9661772294620906]], 'Dragons': [[0, 0.8936966861334641], [1, 1.0302024714036504], [2, 1.1746857445019168], [3, 1.2140468847513437], [7, 1.006875827373483]], 'Emperors': [[0, 0.813266502103614], [1, 1.0282587286620275], [2, 1.2473562278295915], [3, 1.368280402410448], [7, 1.0231761135161177]], 'Guards': [[0, 1.14279798012961], [1, 0.986955993835573], [2, 0.8418000691409029], [3, 0.652110289355298], [7, 0.1756745181144669]], 'Hooligans': [[0, 1.0998402619085006], [1, 1.0397857578905743], [2, 0.8651795468251595], [3, 0.7289591043403384], [7, 0.3683400622692924]], 'Knights': [[0, 1.1087502898189114], [1, 1.0141810133162843], [2, 0.8713285004066393], [3, 0.7483601757338723], [7, 0.3216019056780681]], 'Lotuses': [[0, 0.1], [1, 0.8946508383835152], [2, 1.923011838093503], [3, 2.4530703317746423], [7, 0.8128039684500223]], 'Minotaurs': [[0, 0.980479273509751], [1, 1.0305444507641368], [2, 1.0400708267002412], [3, 1.0863636083890247], [7, 0.8098844320270248]], 'Pirates': [[0, 1.1363596020234519], [1, 0.9993693581289501], [2, 0.8357261716238085], [3, 0.6682182201278684], [7, 0.1961076901462696]], 'Swords': [[0, 1.177847086149485], [1, 1.0453301667567456], [2, 0.8317861145177388], [3, 0.5472015588905387], [7, 0.1]], 'Vigilantes': [[0, 1.0205635495185958], [1, 1.00105211722435], [2, 1.0379530534637447], [3, 0.9806011279729117], [7, 0.8120889905818116]]}}, {'BASE_VALUE': 0.30083176864899014, 'featcomb': 'mult', 'conts': {'Angels': [[0, 1.1059589476939746], [1, 0.9840653819074373], [2, 0.9593524731272883], [3, 0.3570368525975656], [7, 0.1]], 'Battalions': [[0, 1.1757973197336284], [1, 0.8785712888255626], [2, 0.7828428875265416], [3, 0.42346159422279656], [7, 0.1]], 'Dragons': [[0, 0.7637793884107819], [1, 0.975574237567935], [2, 1.1701045665668872], [3, 1.412705395610393], [7, 1.408437552311144]], 'Emperors': [[0, 0.8333182361260598], [1, 1.0208570930961467], [2, 0.990775319605863], [3, 1.3501375415257955], [7, 1.28123120801089]], 'Guards': [[0, 0.8839174457060572], [1, 1.0271353989614656], [2, 1.066713104279137], [3, 1.0699502932754632], [7, 1.338897526401087]], 'Hooligans': [[0, 0.8487558623299875], [1, 1.0011287959193393], [2, 1.0562500530201748], [3, 1.2887189369893506], [7, 1.2139384421849275]], 'Knights': [[0, 0.9284620541924727], [1, 0.9507036687310679], [2, 0.9612141279073725], [3, 1.3234172590930349], [7, 0.6504461343850921]], 'Lotuses': [[0, 1.2146162570552141], [1, 1.0381211307611535], [2, 0.31316474601397293], [3, 0.1], [7, 0.1]], 'Minotaurs': [[0, 0.7727297396043269], [1, 0.9526938141020829], [2, 1.1650388466711874], [3, 1.400324147260357], [7, 1.5328529977024516]], 'Pirates': [[0, 0.9703725004895264], [1, 0.9404883989847531], [2, 0.9609808855985656], [3, 1.112553499637679], [7, 1.118033970899273]], 'Swords': [[0, 0.9867097397754958], [1, 1.1354422861762883], [2, 0.9176470168744405], [3, 0.8658435178730205], [7, 0.1]], 'Vigilantes': [[0, 0.8633675834109938], [1, 0.8862089228922289], [2, 1.1598826778093976], [3, 1.3620569197755241], [7, 1.125113700245195]]}}, {'BASE_VALUE': 0.20055451243266012, 'featcomb': 'mult', 'conts': {'Angels': [[0, 0.7665641605993002], [1, 1.070144483738324], [2, 1.2557998951650715], [3, 1.786146217715191], [7, 0.32227868234902746]], 'Battalions': [[0, 0.6550050322641087], [1, 1.05087335149679], [2, 1.3177400652616413], [3, 1.7335158408250113], [7, 1.931604495131323]], 'Dragons': [[0, 1.167842659987013], [1, 1.0753622973782417], [2, 0.8974810589750271], [3, 0.7332920307095033], [7, 0.3213361320001039]], 'Emperors': [[0, 1.1114378307407469], [1, 1.0351334336363467], [2, 1.1306711293478469], [3, 0.8524832833154359], [7, 0.35725788407811726]], 'Guards': [[0, 0.7923586041098459], [1, 1.0615133231230431], [2, 1.312713301478775], [3, 1.5234945185260895], [7, 1.5836018711671511]], 'Hooligans': [[0, 1.0696333717870834], [1, 1.131612485594905], [2, 1.0647702802206576], [3, 0.8653497291465283], [7, 0.6557680194225247]], 'Knights': [[0, 0.8847772619516364], [1, 1.0752838052461249], [2, 1.229981779963483], [3, 1.3022941094642313], [7, 1.7121913427767719]], 'Lotuses': [[0, 1.2806973973295457], [1, 1.0987791630533772], [2, 0.6625959518488699], [3, 0.11497381381126431], [7, 0.1]], 'Minotaurs': [[0, 1.1648112527425523], [1, 1.0596502139124029], [2, 0.9022829475593572], [3, 0.8071213307033367], [7, 0.35327050316830133]], 'Pirates': [[0, 0.9854609262058487], [1, 1.1410635321331388], [2, 1.1655052480875547], [3, 1.0750092405506237], [7, 0.7946462289974963]], 'Swords': [[0, 1.3255549516071168], [1, 1.0342140560093382], [2, 0.7185596480063777], [3, 0.16683895183675354], [7, 0.1]], 'Vigilantes': [[0, 0.906117208308784], [1, 1.0801003707064771], [2, 1.1778208633792622], [3, 1.3330791414620586], [7, 1.5618057278469613]]}}, {'BASE_VALUE': 0.10027725621633006, 'featcomb': 'mult', 'conts': {'Angels': [[0, 1.0177001826232648], [1, 1.1798003835411834], [2, 1.141041745366244], [3, 1.4329665019507463], [7, 0.1819578217522648]], 'Battalions': [[0, 1.3047655483295053], [1, 1.0538609477868046], [2, 0.8314883043661523], [3, 0.6776829617380568], [7, 0.26008254148198723]], 'Dragons': [[0, 1.1728017559480068], [1, 1.1360115375266693], [2, 1.0099983451041772], [3, 0.9952209799828031], [7, 0.6849418868949217]], 'Emperors': [[0, 1.239705629580708], [1, 1.0513367018041484], [2, 0.990659043900418], [3, 0.9248369786438965], [7, 0.29775687957511654]], 'Guards': [[0, 1.1980407946338882], [1, 1.1122577251345458], [2, 1.0696179502760679], [3, 0.8467967691893322], [7, 0.535025640064316]], 'Hooligans': [[0, 0.8461770128729149], [1, 1.1133885453349655], [2, 1.3992079224745024], [3, 1.6038309900666843], [7, 1.4850150557947708]], 'Knights': [[0, 1.2379446542857528], [1, 1.1638143558621086], [2, 0.9224270981200575], [3, 0.6356102503979758], [7, 0.23600804224134245]], 'Lotuses': [[0, 1.3269444316118673], [1, 1.1031617582999802], [2, 0.7587104971750295], [3, 0.5210024933521111], [7, 0.1]], 'Minotaurs': [[0, 1.0933437837203754], [1, 1.1778918821983442], [2, 1.1633409508579082], [3, 0.9687366206162012], [7, 1.1676482773931844]], 'Pirates': [[0, 0.6077749926970059], [1, 1.148912783282542], [2, 1.651482263144897], [3, 1.7298466520230211], [7, 1.453696851106485]], 'Swords': [[0, 0.26568785124019617], [1, 0.9366392326853828], [2, 1.62924060577719], [3, 2.410892754532979], [7, 1.2134366450519414]], 'Vigilantes': [[0, 1.210547612045707], [1, 1.1625379201289834], [2, 1.026280356337791], [3, 0.6708599960955015], [7, 0.2244722479405696]]}}]

testDf["Predicted"] = misc.predict(testDf, models, calculus.Cratio_mlink)
testDf["Actual"] = testDf["Deck_A_Win?"]

print("GINI: " + str(metrics.get_gini(testDf,"Predicted","Actual")))
p, a = metrics.get_Xiles(testDf,"Predicted","Actual")

print("DECILES")
print([util.round_to_sf(x) for x in p])
print([util.round_to_sf(x) for x in a])


wraps.viz_cratio_models(models, "4_model")

